<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AJ Crackers - Customer View</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      margin: 0;
    }
    header {
      background-color: #d9534f;
      color: white;
      padding: 15px 20px;
      text-align: center;
    }
    header h1 {
      margin: 0;
      font-size: 28px;
    }
    header .tagline {
      font-size: 14px;
      margin-top: 5px;
      color: #ffe;
    }

    /* Container for search + filters aligned right */
    #filterContainer {
      display: flex;
      justify-content: flex-end;
      gap: 15px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    #filterContainer label {
      font-size: 14px;
      display: flex;
      flex-direction: column;
      color: #333;
    }
    #filterContainer input[type="text"],
    #filterContainer input[type="number"] {
      padding: 6px;
      width: 150px;
      max-width: 100%;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-top: 4px;
    }
    #filterContainer input[type="number"] {
      width: 80px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: center;
    }
    th {
      background-color: #f2f2f2;
    }
    input[type="number"] {
      width: 60px;
      padding: 6px;
      font-size: 14px;
      text-align: center;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .category-header {
      background-color: #e9ecef;
      cursor: pointer;
      user-select: none;
      font-weight: bold;
      text-align: left;
      padding-left: 15px;
      font-size: 16px;
    }
    .category-content {
      display: none;
    }
    .category-expanded .category-content {
      display: table-row-group;
    }
    .category-toggle::before {
      content: "‚ñº";
      display: inline-block;
      margin-right: 6px;
      transition: transform 0.3s ease;
    }
    .category-expanded > .category-header .category-toggle::before {
      transform: rotate(-180deg);
    }

    .total-section {
      margin-top: 20px;
      font-size: 18px;
      font-weight: bold;
    }
    .button-group {
      margin-top: 20px;
    }
    .button-group button {
      padding: 12px 20px;
      font-size: 16px;
      margin-right: 10px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
    }
    .whatsapp-button {
      background-color: #25D366;
      color: white;
    }
    .print-button {
      background-color: #007bff;
      color: white;
    }
    .footer-note {
      margin-top: 20px;
      color: #888;
      font-size: 14px;
    }
    .offer-days-left {
      font-size: 16px;
      margin-top: 10px;
      color: #555;
    }
    footer {
      background-color: #f2f2f2;
      padding: 20px;
      margin-top: 40px;
      font-size: 14px;
      text-align: center;
      color: #444;
    }
    footer .safety {
      color: #d9534f;
      font-weight: bold;
      margin-top: 10px;
    }
    .highlight-offer {
      background: #fff3cd;
      border: 2px solid #ffc107;
      padding: 15px;
      border-radius: 10px;
      margin-top: 15px;
      margin-bottom: 20px;
      text-align: center;
      font-size: 18px;
      color: #333;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .blink-text {
      animation: blink-fast 1s infinite;
      color: #e60000;
      font-weight: bold;
    }

    .blink-slow {
      animation: blink-slow 2.5s infinite;
      color: #d9534f;
      font-weight: bold;
    }

    @keyframes blink-fast {
      50% {
        opacity: 0;
      }
    }

    @keyframes blink-slow {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.3;
      }
    }
  </style>
</head>
<body>

<header>
  <h1>üéá AJ Crackers</h1>
  <div class="tagline">Your Trusted Firework Partner</div>
</header>

<div class="highlight-offer">
  <p><strong>üéÅ Offer: Flat <span class="blink-text">70%</span> Discount Applied</strong></p>
  <p class="days-left blink-slow">üî• Hurry! Only <span id="daysLeft">115</span> days left for this offer!</p>
</div>

<!-- Filters container -->
<div id="filterContainer">
  <label>
    Search Fireworks:
    <input type="text" id="searchInput" placeholder="Type to search..." />
  </label>
  <label>
    Min Price (‚Çπ):
    <input type="number" id="minPrice" min="0" placeholder="0" />
  </label>
  <label>
    Max Price (‚Çπ):
    <input type="number" id="maxPrice" min="0" placeholder="99999" />
  </label>
</div>

<table id="productTable">
  <thead>
    <tr>
      <th>Firework Name</th>
      <th>Original Price (‚Çπ)</th>
      <th>Quantity</th>
      <th>Total (‚Çπ)</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="total-section">
  <p>Discount: <strong id="discountPercent">70%</strong></p>
  <p>Total Original Price: ‚Çπ<span id="originalTotal">0.00</span></p>
  <p>Total Discount Amount: ‚Çπ<span id="discountAmount">0.00</span></p>
  <p><strong>Grand Total (After Discount): ‚Çπ<span id="grandTotal">0.00</span></strong></p>
</div>

<div class="button-group">
  <button class="whatsapp-button" onclick="sendOrderToWhatsApp()">Send Order via WhatsApp</button>
  <button class="print-button" onclick="window.print()">Print Order</button>
</div>

<p class="footer-note">* Offer is fixed and prices shown are after discount. Prices inclusive of taxes.</p>

<footer>
  <p><strong>AJ Crackers</strong> ‚Äî Your Trusted Firework Partner</p>
  <p>Contact: +91 82967 72217, 99436 81121 | Email: support@rajcrackers.in</p>
  <p>¬© 2025 AJ Crackers. All rights reserved.</p>
  <p class="safety">üî• Please celebrate responsibly and follow firework safety rules!</p>
</footer>

<script>
  let currentOffer = 70;
  let allProductsGrouped = {};

  function showDaysLeft() {
    const offerEndDate = new Date("2025-10-25");
    const today = new Date();
    const timeDiff = offerEndDate - today;
    const daysLeft = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
    const msg = daysLeft > 0
      ? `üî• Hurry! Only ${daysLeft} day${daysLeft !== 1 ? 's' : ''} left for this offer!`
      : '‚ö†Ô∏è The offer has ended.';
    document.querySelector(".days-left").textContent = msg;
  }

  function loadProducts() {
    fetch("products.json")
      .then(res => res.json())
      .then(data => {
        console.log("Loaded products:", data);

        try {
          const storedOffer = JSON.parse(localStorage.getItem("fireworkOffer")) || { offer: 70 };
          currentOffer = storedOffer.offer;

          document.getElementById("discountPercent").textContent = `${currentOffer}%`;

          // Group products by category
          const grouped = {};
          Object.entries(data).forEach(([name, details]) => {
            // If your products.json has structure like:
            // { "kambi mathappu": {"price":20, "category":"Rocket"}, ... }
            // else fallback to price and "Uncategorized"
            let price = NaN, category = "Uncategorized";
            if (typeof details === "object" && details !== null) {
              price = parseFloat(details.price);
              category = details.category || "Uncategorized";
            } else {
              // If just price number directly, no category
              price = parseFloat(details);
            }
            if (isNaN(price)) price = 0;

            if (!grouped[category]) grouped[category] = [];
            grouped[category].push({ name, price });
          });

          allProductsGrouped = grouped;
          renderFilteredProducts();

        } catch (err) {
          console.error("‚ùå Error inside .then():", err);
          document.querySelector("#productTable tbody").innerHTML = `<tr><td colspan="4">Failed to load products.</td></tr>`;
        }
      })
      .catch(err => {
        console.error("Error loading products.json:", err);
        document.querySelector("#productTable tbody").innerHTML = `<tr><td colspan="4">Failed to load products.</td></tr>`;
      });
  }

  function renderFilteredProducts() {
    const searchTerm = document.getElementById("searchInput").value.trim().toLowerCase();
    const minPrice = parseFloat(document.getElementById("minPrice").value);
    const maxPrice = parseFloat(document.getElementById("maxPrice").value);

    // Filter products by search and price range
    const filteredGrouped = {};
    Object.entries(allProductsGrouped).forEach(([category, products]) => {
      const filtered = products.filter(item => {
        const matchesSearch = item.name.toLowerCase().includes(searchTerm);
        const aboveMin = isNaN(minPrice) || item.price >= minPrice;
        const belowMax = isNaN(maxPrice) || item.price <= maxPrice;
        return matchesSearch && aboveMin && belowMax;
      });
      if (filtered.length > 0) {
        filteredGrouped[category] = filtered;
      }
    });

    renderProductTableGrouped(filteredGrouped);
    calculateTotals();
  }

  function renderProductTableGrouped(groupedProducts) {
    const tbody = document.querySelector("#productTable tbody");
    tbody.innerHTML = "";

    if (Object.keys(groupedProducts).length === 0) {
      tbody.innerHTML = `<tr><td colspan="4">No products found matching criteria.</td></tr>`;
      return;
    }

    const offerMultiplier = (100 - currentOffer) / 100;

    Object.entries(groupedProducts).forEach(([category, products]) => {
      // Category header row
      const categoryRow = document.createElement("tr");
      categoryRow.classList.add("category-header-row");
      categoryRow.innerHTML = `<td colspan="4" class="category-header"><span class="category-toggle">‚ñº</span> ${category}</td>`;
      tbody.appendChild(categoryRow);

      // Wrap category products in a tbody for collapsible effect
      const categoryBody = document.createElement("tbody");
      categoryBody.classList.add("category-content");

      products.forEach(item => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${item.name}</td>
          <td>‚Çπ${item.price.toFixed(2)}</td>
          <td><input type="number" min="0" value="0" onchange="calculateTotals()" data-name="${item.name}" data-original="${item.price}" /></td>
          <td class="item-total">‚Çπ0.00</td>
        `;
        categoryBody.appendChild(row);
      });

      tbody.appendChild(categoryBody);
    });

    // Add toggle functionality for categories
    const headers = tbody.querySelectorAll(".category-header");
    headers.forEach(header => {
      header.onclick = () => {
        const tr = header.parentElement;
        tr.classList.toggle("category-expanded");
      };
    });
  }

  function calculateTotals() {
    const offerMultiplier = (100 - currentOffer) / 100;
    let originalTotal = 0, discountTotal = 0, finalTotal = 0;

    const rows = document.querySelectorAll("#productTable tbody tr:not(.category-header-row)"); // exclude category headers

    rows.forEach(row => {
      const qtyInput = row.querySelector("input[type='number']");
      if (!qtyInput) return; // skip header rows

      const qty = parseInt(qtyInput.value) || 0;
      const originalPrice = parseFloat(qtyInput.dataset.original);
      const discountedPrice = originalPrice * offerMultiplier;
      const itemTotal = qty * discountedPrice;

      const originalSubtotal = qty * originalPrice;
      const discountAmount = originalSubtotal - itemTotal;

      row.querySelector(".item-total").textContent = `‚Çπ${itemTotal.toFixed(2)}`;

      originalTotal += originalSubtotal;
      discountTotal += discountAmount;
      finalTotal += itemTotal;
    });

    document.getElementById("originalTotal").textContent = originalTotal.toFixed(2);
    document.getElementById("discountAmount").textContent = discountTotal.toFixed(2);
    document.getElementById("grandTotal").textContent = finalTotal.toFixed(2);
  }

  function sendOrderToWhatsApp() {
    const orderLines = [];
    const rows = document.querySelectorAll("#productTable tbody tr:not(.category-header-row)");

    rows.forEach(row => {
      const qtyInput = row.querySelector("input[type='number']");
      if (!qtyInput) return;
      const qty = parseInt(qtyInput.value) || 0;
      if (qty === 0) return;

      const name = qtyInput.dataset.name;
      const price = qtyInput.dataset.original;
      orderLines.push(`${name} x ${qty} (‚Çπ${price})`);
    });

    if (orderLines.length === 0) {
      alert("Please add some quantity before sending order.");
      return;
    }

    const total = document.getElementById("grandTotal").textContent;
    const message = encodeURIComponent(
      `Order from AJ Crackers:\n\n${orderLines.join("\n")}\n\nGrand Total: ‚Çπ${total}\n\nThank you!`
    );

    const phoneNumber = "918296772217"; // Use your number with country code without +
    window.open(`https://wa.me/${phoneNumber}?text=${message}`, "_blank");
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadProducts();
    document.getElementById("searchInput").addEventListener("input", renderFilteredProducts);
    document.getElementById("minPrice").addEventListener("input", renderFilteredProducts);
    document.getElementById("maxPrice").addEventListener("input", renderFilteredProducts);
    showDaysLeft();
  });
</script>

</body>
</html>
